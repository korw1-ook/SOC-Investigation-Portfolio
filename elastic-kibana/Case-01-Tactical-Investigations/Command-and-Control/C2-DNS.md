# Hunting Command and Control over DNS

we will use the packetbeat-* index and hunt for potential C2 over DNS on July 3, 2023. In addition, we will use the winlogbeat-* index to correlate the DNS queries to identify the malicious process generating it

## Evidence

**KQL** : network.protocol: dns AND NOT dns.question.name: *arpa

use the Visualize Library again and create a visualisation table using Lens. Ensure that the table is configured with the following:

Set the Table Index (packetbeat), Rows (dns.question.registered_domain and host.name), and Metrics (Unique Count of dns.question.subdomain).

![image](../images/c2/c2.png)

it can be observed that an unusual domain golge.xyz queried 2188 unique subdomains, which may indicate a potential C2 over DNS activity coming from WKSTN-1. 

---
To better understand the attack, we can continue the investigation using the Discover tab 

**KQL** : network.protocol: dns AND NOT dns.question.name: *arpa AND dns.question.registered_domain: golge.xyz AND host.name: WKSTN-1


add the query field as a column to see its values.

![image](../images/c2/query.png)

Based on the results, the workstation seems to be continuously querying on golge.xyz, using different query types (CNAME, TXT and MX) and using hexadecimal subdomains

---
we can correlate this activity on winlogbeat-* to identify the process executing the DNS requests 

**KQL** : host.name: WKSTN-1* AND destination.ip: 167.71.198.43 AND destination.port: 53

In addition, ensure that the following fields are added as columns to aid us in our investigation:

* host.name
* user.name
* process.parent.command_line
* process.name
* process.command_line

![image](../images/c2/ns.png)

## conclusion

Based on the results, it can be observed that all connections to 167.71.198.43:53 are generated by nslookup.exe ,the suspicion of C2 over DNS is confirmed